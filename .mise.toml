# SPDX-License-Identifier: Apache-2.0
#
# mise task definitions for LamaDist
# See docs/TOOLING.md for usage information.

min_version = "2024.9.0"

[env]
# Project root (resolved at runtime)
LAMADIST_PROJECT_DIR = "{{config_root}}"
LAMADIST_CONTAINER_IMAGE = "lamawithonel/lamadist-builder:latest"
LAMADIST_HOST_SSTATE_DIR = "{{config_root}}/.cache/sstate"
LAMADIST_CONTAINER_CMD = "podman"
KAS_WORK_DIR = "/0"
SSTATE_DIR = "/sstate"

# ──────────────────────────────────────────────
# Build tasks
# ──────────────────────────────────────────────

[tasks.build]
description = "Build images for specified BSP"
usage = '''
flag "--bsp <bsp>" help="BSP target to build" default="x86_64" {
    choices "x86_64" "orin-nx" "rk1" "soquartz"
}
'''
run = """
#!/usr/bin/env bash
set -euo pipefail

BSP="${usage_bsp:-x86_64}"

KAS_CONFIG="${KAS_WORK_DIR}/kas/main.kas.yml:${KAS_WORK_DIR}/kas/bsp/${BSP}.kas.yml"
KAS_DEBUG="${KAS_WORK_DIR}/kas/extras/debug.kas.yml"

mkdir -p "${LAMADIST_HOST_SSTATE_DIR}"

KAS_ENV_LOCAL=""
if [[ -f "${LAMADIST_PROJECT_DIR}/.kas.env.local" ]]; then
    KAS_ENV_LOCAL="--env-file ${LAMADIST_PROJECT_DIR}/.kas.env.local"
fi

USERNS_ARGS=""
if [[ "${LAMADIST_CONTAINER_CMD}" == "podman" ]]; then
    USERNS_ARGS="--userns=keep-id"
fi

${LAMADIST_CONTAINER_CMD} run --rm -it \
    --privileged \
    ${USERNS_ARGS} \
    -v "${LAMADIST_HOST_SSTATE_DIR}:${SSTATE_DIR}" \
    -e "SSTATE_DIR=${SSTATE_DIR}" \
    -v "${LAMADIST_PROJECT_DIR}:${KAS_WORK_DIR}" \
    -e "KAS_WORK_DIR=${KAS_WORK_DIR}" \
    --env-file "${LAMADIST_PROJECT_DIR}/.kas.env" ${KAS_ENV_LOCAL} \
    "${LAMADIST_CONTAINER_IMAGE}" \
    --log-level debug build "${KAS_CONFIG}:${KAS_DEBUG}"
"""

[tasks.ci-build]
description = "Build with CI settings (force checkout, update)"
usage = '''
flag "--bsp <bsp>" help="BSP target to build" default="x86_64" {
    choices "x86_64" "orin-nx" "rk1" "soquartz"
}
'''
run = """
#!/usr/bin/env bash
set -euo pipefail

BSP="${usage_bsp:-x86_64}"

KAS_CONFIG="${KAS_WORK_DIR}/kas/main.kas.yml:${KAS_WORK_DIR}/kas/bsp/${BSP}.kas.yml"

mkdir -p "${LAMADIST_HOST_SSTATE_DIR}"

KAS_ENV_LOCAL=""
if [[ -f "${LAMADIST_PROJECT_DIR}/.kas.env.local" ]]; then
    KAS_ENV_LOCAL="--env-file ${LAMADIST_PROJECT_DIR}/.kas.env.local"
fi

USERNS_ARGS=""
if [[ "${LAMADIST_CONTAINER_CMD}" == "podman" ]]; then
    USERNS_ARGS="--userns=keep-id"
fi

${LAMADIST_CONTAINER_CMD} run --rm -it \
    --privileged \
    ${USERNS_ARGS} \
    -v "${LAMADIST_HOST_SSTATE_DIR}:${SSTATE_DIR}" \
    -e "SSTATE_DIR=${SSTATE_DIR}" \
    -v "${LAMADIST_PROJECT_DIR}:${KAS_WORK_DIR}" \
    -e "KAS_WORK_DIR=${KAS_WORK_DIR}" \
    --env-file "${LAMADIST_PROJECT_DIR}/.kas.env" ${KAS_ENV_LOCAL} \
    "${LAMADIST_CONTAINER_IMAGE}" \
    build --force-checkout --update "${KAS_CONFIG}"
"""

[tasks.container]
description = "Build the KAS build container image"
run = """
#!/usr/bin/env bash
set -euo pipefail

${LAMADIST_CONTAINER_CMD} build -t "${LAMADIST_CONTAINER_IMAGE}" "${LAMADIST_PROJECT_DIR}/container/"
"""

# ──────────────────────────────────────────────
# Development tasks
# ──────────────────────────────────────────────

[tasks.shell]
description = "Interactive KAS shell for specified BSP"
usage = '''
flag "--bsp <bsp>" help="BSP target" default="x86_64" {
    choices "x86_64" "orin-nx" "rk1" "soquartz"
}
'''
run = """
#!/usr/bin/env bash
set -euo pipefail

BSP="${usage_bsp:-x86_64}"

KAS_CONFIG="${KAS_WORK_DIR}/kas/main.kas.yml:${KAS_WORK_DIR}/kas/bsp/${BSP}.kas.yml"
KAS_DEBUG="${KAS_WORK_DIR}/kas/extras/debug.kas.yml"

mkdir -p "${LAMADIST_HOST_SSTATE_DIR}"

KAS_ENV_LOCAL=""
if [[ -f "${LAMADIST_PROJECT_DIR}/.kas.env.local" ]]; then
    KAS_ENV_LOCAL="--env-file ${LAMADIST_PROJECT_DIR}/.kas.env.local"
fi

USERNS_ARGS=""
if [[ "${LAMADIST_CONTAINER_CMD}" == "podman" ]]; then
    USERNS_ARGS="--userns=keep-id"
fi

${LAMADIST_CONTAINER_CMD} run --rm -it \
    --privileged \
    ${USERNS_ARGS} \
    -v "${LAMADIST_HOST_SSTATE_DIR}:${SSTATE_DIR}" \
    -e "SSTATE_DIR=${SSTATE_DIR}" \
    -v "${LAMADIST_PROJECT_DIR}:${KAS_WORK_DIR}" \
    -e "KAS_WORK_DIR=${KAS_WORK_DIR}" \
    --env-file "${LAMADIST_PROJECT_DIR}/.kas.env" ${KAS_ENV_LOCAL} \
    "${LAMADIST_CONTAINER_IMAGE}" \
    shell "${KAS_CONFIG}:${KAS_DEBUG}"
"""

[tasks.container-shell]
description = "Shell in container (without KAS)"
run = """
#!/usr/bin/env bash
set -euo pipefail

mkdir -p "${LAMADIST_HOST_SSTATE_DIR}"

KAS_ENV_LOCAL=""
if [[ -f "${LAMADIST_PROJECT_DIR}/.kas.env.local" ]]; then
    KAS_ENV_LOCAL="--env-file ${LAMADIST_PROJECT_DIR}/.kas.env.local"
fi

USERNS_ARGS=""
if [[ "${LAMADIST_CONTAINER_CMD}" == "podman" ]]; then
    USERNS_ARGS="--userns=keep-id"
fi

${LAMADIST_CONTAINER_CMD} run --rm -it \
    --privileged \
    ${USERNS_ARGS} \
    -v "${LAMADIST_HOST_SSTATE_DIR}:${SSTATE_DIR}" \
    -e "SSTATE_DIR=${SSTATE_DIR}" \
    -v "${LAMADIST_PROJECT_DIR}:${KAS_WORK_DIR}" \
    -e "KAS_WORK_DIR=${KAS_WORK_DIR}" \
    --env-file "${LAMADIST_PROJECT_DIR}/.kas.env" ${KAS_ENV_LOCAL} \
    --entrypoint /bin/dumb-init \
    "${LAMADIST_CONTAINER_IMAGE}" \
    /bin/bash
"""

[tasks.dump]
description = "Dump KAS configuration for specified BSP"
usage = '''
flag "--bsp <bsp>" help="BSP target" default="x86_64" {
    choices "x86_64" "orin-nx" "rk1" "soquartz"
}
'''
run = """
#!/usr/bin/env bash
set -euo pipefail

BSP="${usage_bsp:-x86_64}"

KAS_CONFIG="${KAS_WORK_DIR}/kas/main.kas.yml:${KAS_WORK_DIR}/kas/bsp/${BSP}.kas.yml"
KAS_DEBUG="${KAS_WORK_DIR}/kas/extras/debug.kas.yml"

mkdir -p "${LAMADIST_HOST_SSTATE_DIR}"

KAS_ENV_LOCAL=""
if [[ -f "${LAMADIST_PROJECT_DIR}/.kas.env.local" ]]; then
    KAS_ENV_LOCAL="--env-file ${LAMADIST_PROJECT_DIR}/.kas.env.local"
fi

USERNS_ARGS=""
if [[ "${LAMADIST_CONTAINER_CMD}" == "podman" ]]; then
    USERNS_ARGS="--userns=keep-id"
fi

${LAMADIST_CONTAINER_CMD} run --rm -it \
    --privileged \
    ${USERNS_ARGS} \
    -v "${LAMADIST_HOST_SSTATE_DIR}:${SSTATE_DIR}" \
    -e "SSTATE_DIR=${SSTATE_DIR}" \
    -v "${LAMADIST_PROJECT_DIR}:${KAS_WORK_DIR}" \
    -e "KAS_WORK_DIR=${KAS_WORK_DIR}" \
    --env-file "${LAMADIST_PROJECT_DIR}/.kas.env" ${KAS_ENV_LOCAL} \
    "${LAMADIST_CONTAINER_IMAGE}" \
    dump "${KAS_CONFIG}:${KAS_DEBUG}"
"""

# ──────────────────────────────────────────────
# Cleanup tasks
# ──────────────────────────────────────────────

[tasks.clean]
description = "Remove build output artifacts"
run = """
#!/usr/bin/env bash
set -euo pipefail
rm -rf "${LAMADIST_PROJECT_DIR}/build/tmp/deploy"
echo "Cleaned build output artifacts."
"""

[tasks."clean:all"]
description = "Remove entire build directory (with confirmation)"
run = """
#!/usr/bin/env bash
set -euo pipefail
read -p 'Are you sure you want to remove the full build directory? [y/N] ' -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 1
fi
rm -rf "${LAMADIST_PROJECT_DIR}/build"
echo "Removed entire build directory."
"""

[tasks."clean:sstate"]
description = "Clean shared state cache (with confirmation)"
run = """
#!/usr/bin/env bash
set -euo pipefail
read -p 'Are you sure you want to remove the shared state cache? [y/N] ' -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 1
fi
rm -rf "${LAMADIST_HOST_SSTATE_DIR}"/*
echo "Cleaned shared state cache."
"""

[tasks."clean:container"]
description = "Remove container image"
run = """
#!/usr/bin/env bash
set -euo pipefail
${LAMADIST_CONTAINER_CMD} rmi "${LAMADIST_CONTAINER_IMAGE}" || true
echo "Removed container image."
"""

# ──────────────────────────────────────────────
# Utility tasks
# ──────────────────────────────────────────────

[tasks.version]
description = "Show build version (via GitVersion)"
run = """
#!/usr/bin/env bash
set -euo pipefail

USERNS_ARGS=""
if [[ "${LAMADIST_CONTAINER_CMD}" == "podman" ]]; then
    USERNS_ARGS="--userns=keep-id"
fi

${LAMADIST_CONTAINER_CMD} run --rm ${USERNS_ARGS} -v "${LAMADIST_PROJECT_DIR}:/repo" gittools/gitversion /repo /showvariable FullSemVer
"""
